services:
  - docker
sudo: required

script:
  - docker build --tag autorest.devops .

  - git clone https://github.com/zikalino/azure-rest-api-specs.git ~/azure-rest-api-specs
  - git clone https://zikalino:${GH_TOKEN}@github.com/zikalino/devops-hatchery.git ~/devops-hatchery
  - git clone https://zikalino:${GH_TOKEN}@github.com/zikalino/magic-module-specs.git ~/magic-module-specs;
  - git clone https://github.com/vschina/magic-modules.git ~/magic-modules
  - echo $(pwd)
  - export CURRENT_PATH=$(pwd)
  - cd ~/devops-hatchery; git checkout autogenerated -- ~/devops-hatchery || git checkout -B autogenerated
  - mkdir -p ~/devops-hatchery/generated
  - rm -rf ~/devops-hatchery/generated/*
  - docker run -t -i -v $CURRENT_PATH:/autorest.devops -w /autorest.devops autorest.devops npm install

  - "cd $CURRENT_PATH/input;
     for d in *; do
        echo ---------------------------------------------------------------------------------;
        echo Processing: $d;
        echo ---------------------------------------------------------------------------------;
        docker run -t -i
        -v $CURRENT_PATH:/autorest.devops
        -v ~/azure-rest-api-specs:/azure-rest-api-specs
        -v ~/devops-hatchery/generated:/generated
        autorest.devops
        autorest
        --azureresourceschema
        --use=/autorest.devops
        --python-sdks-folder=/generated
        --output-folder=/generated
        /autorest.devops/input/$d;
     done"

  # just try to set up and run magic modules
  - 'echo ---------------------------------------------------------------------------------;
     echo Running Magic Modules;
     echo ---------------------------------------------------------------------------------;
     docker run -t -i
     -v $CURRENT_PATH:/autorest.devops
     -v ~/azure-rest-api-specs:/azure-rest-api-specs
     -v ~/devops-hatchery/generated:/generated
     -v ~/magic-modules:/magic-modules
     autorest.devops
     /bin/bash -c "
     cd /magic-modules;
     bundle install;
     git checkout azure_backend;
     bundle exec compiler -p products/azbatchaccount -e ansible -o /generated
     "'

after_success:
  - ls -al ~/devops-hatchery/generated
  - ls -al ~/devops-hatchery/generated/magic-modules-input
  - ls -al ~/devops-hatchery/generated/ansible-module-drafts
  - git config --global user.email "zikalino@microsoft.com"
  - git config --global user.name "zikalino"
  - cd ~/devops-hatchery ; git config credential.helper store
  - cd ~/magic-module-specs; git config credential.helper store
  - echo "https://zikalino:${GH_TOKEN}@github.com" > ~/.git-credentials

  - cd ~/devops-hatchery ; git add -A ; git commit -m "autogenerated" ; git push --set-upstream origin autogenerated
  - cd ~/magic-module-specs; (git checkout autogenerated || git checkout -B autogenerated); mkdir -p products
  - cp -R ~/devops-hatchery/generated/magic-modules-input/azure_rm_batchacc* ~/magic-module-specs/products
  - cd ~/magic-module-specs ; git add -A ; git commit -m "autogenerated" ; git push --set-upstream origin autogenerated
